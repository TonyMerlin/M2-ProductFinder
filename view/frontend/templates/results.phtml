<?php
/** @var \Merlin\ProductFinder\Block\Results $block */ $collection = $block->getCollection();
$params     = $block->getFinderParams();
$order      = $params['order'];
$dir        = $params['dir'];
$limit      = (int)$params['limit'];

$currentUrl = $block->getUrl('*/*/*', ['_current' => true, '_use_rewrite' => true]); $baseQuery  = $_GET ?? [];

// image helper
$om          = \Magento\Framework\App\ObjectManager::getInstance();
/** @var \Magento\Catalog\Helper\Image $imageHelper */ $imageHelper = $om->get(\Magento\Catalog\Helper\Image::class);
$imageRole   = 'category_page_grid';
$thumbW      = 300;
$thumbH      = 300;

// collection / summary
$total   = (int)$collection->getSize();
$curPage = max(1, (int)$collection->getCurPage());
$from    = $total ? (($curPage - 1) * $limit) + 1 : 0;
$to      = $total ? min($from + $collection->count() - 1, $total) : 0;

// sort label (simple, safe PHP)
$orderLabel = (string)__('Name');
if ($order === 'price') {
    $orderLabel = (string)__('Price');
} elseif ($order === 'created_at') {
    $orderLabel = (string)__('Newest');
}

// direction label (ASCII only)
$dirLabel = ($dir === 'DESC') ? 'Z-A' : 'A-Z'; ?> <div class="merlin-results">

    <div class="merlin-results__toolbar">
        <div class="merlin-results__summary <?= $total ? '' : 'merlin-results__summary--empty' ?>">
            <?php if ($total): ?>
                <span class="merlin-results__summary-main">
                    <?= $from ?>-<?= $to ?> <?= __('of') ?> <?= $total ?> <?= __('products found') ?>
                </span>
                <span class="merlin-results__summary-meta">
                    &bull; <?= __('Sorted by') ?>
                    <?= $block->escapeHtml($orderLabel) ?>
                    (<?= $block->escapeHtml($dirLabel) ?>)
                </span>
            <?php else: ?>
                <span class="merlin-results__summary-main">
                    <?= __('No products found for your current filters.') ?>
                </span>
            <?php endif; ?>
        </div>

        <form method="get"
              action="<?= $block->escapeUrl($currentUrl) ?>"
              class="merlin-toolbar-form">

            <?php foreach ($baseQuery as $k => $v): ?>
                <?php
                if (in_array($k, ['order','dir','limit','p'], true)) {
                    continue;
                }
                ?>
                <?php if (is_array($v)): ?>
                    <?php foreach ($v as $vv): ?>
                        <input type="hidden"
                               name="<?= $block->escapeHtmlAttr($k) ?>[]"
                               value="<?= $block->escapeHtmlAttr($vv) ?>" />
                    <?php endforeach; ?>
                <?php else: ?>
                    <input type="hidden"
                           name="<?= $block->escapeHtmlAttr($k) ?>"
                           value="<?= $block->escapeHtmlAttr($v) ?>" />
                <?php endif; ?>
            <?php endforeach; ?>

            <div class="merlin-toolbar-group">
                <label><?= __('Sort By') ?></label>
                <select name="order" onchange="this.form.submit()">
                    <option value="name" <?= $order === 'name' ? 'selected' : '' ?>><?= __('Name') ?></option>
                    <option value="price" <?= $order === 'price' ? 'selected' : '' ?>><?= __('Price') ?></option>
                    <option value="created_at" <?= $order === 'created_at' ? 'selected' : '' ?>><?= __('Newest') ?></option>
                </select>
                <select name="dir" onchange="this.form.submit()">
                    <option value="ASC" <?= $dir === 'ASC' ? 'selected' : '' ?>><?= __('Asc') ?></option>
                    <option value="DESC" <?= $dir === 'DESC' ? 'selected' : '' ?>><?= __('Desc') ?></option>
                </select>
            </div>

            <div class="merlin-toolbar-group">
                <label><?= __('Show') ?></label>
                <select name="limit" onchange="this.form.submit()">
                    <?php foreach ([12, 24, 48] as $l): ?>
                        <option value="<?= $l ?>" <?= $limit === $l ? 'selected' : '' ?>><?= $l ?></option>
                    <?php endforeach; ?>
                </select>
            </div>
        </form>
    </div>

    <?php if (!$collection || !$collection->getSize()): ?>
        <p><?= __('No products matched your selection.') ?></p>
    <?php else: ?>
        <?php
        // top pager
        /** @var \Magento\Theme\Block\Html\Pager $pagerTop */
        $pagerTop = $block->getLayout()->createBlock(\Magento\Theme\Block\Html\Pager::class);
        if ($pagerTop) {
            $pagerTop->setAvailableLimit([12 => 12, 24 => 24, 48 => 48])
                ->setShowPerPage(false)
                ->setLimit($limit)
                ->setCollection($collection);
            echo $pagerTop->toHtml();
        }
        ?>

        <div class="merlin-grid-cards">
            <?php foreach ($collection as $product): ?>
                <?php
                // build a resized image url
                $resizedUrl = '';
                try {
                    $resizedUrl = $imageHelper
                        ->init($product, $imageRole)
                        ->resize($thumbW, $thumbH)
                        ->getUrl();
                } catch (\Exception $e) {
                    $resizedUrl = '';
                }

                $prices = $block->getDisplayPrices($product);
                ?>
                <div class="merlin-card">
                    <a href="<?= $product->getProductUrl() ?>" class="merlin-card__image">
                        <?php if ($resizedUrl): ?>
                            <img src="<?= $block->escapeUrl($resizedUrl) ?>"
                                 alt="<?= $block->escapeHtmlAttr($product->getName()) ?>"
                                 loading="lazy"
                                 width="<?= $thumbW ?>" height="<?= $thumbH ?>" />
                        <?php else: ?>
                            <span class="merlin-thumb"><?= $block->escapeHtml($product->getName()) ?></span>
                        <?php endif; ?>
                    </a>
                    <div class="merlin-card__body">
                        <a class="merlin-card__title" href="<?= $product->getProductUrl() ?>">
                            <?= $block->escapeHtml($product->getName()) ?>
                        </a>

                        <div class="merlin-card__price">
                            <?php if ($prices['special_raw'] !== null): ?>
                                <span class="merlin-price--old"><?= /* @noEscape */ $prices['price_html'] ?></span>
                                <span class="merlin-price--special"><?= /* @noEscape */ $prices['special_html'] ?></span>
                                <?php if (!empty($prices['percent_off'])): ?>
                                    <span class="merlin-price__badge">-<?= (int)$prices['percent_off'] ?>%</span>
                                <?php endif; ?>
                            <?php else: ?>
                                <span class="merlin-price--regular"><?= /* @noEscape */ $prices['price_html'] ?></span>
                            <?php endif; ?>
                        </div>

                        <a class="action primary merlin-card__cta" href="<?= $product->getProductUrl() ?>">
                            <?= __('View') ?>
                        </a>
                    </div>
                </div>
            <?php endforeach; ?>
        </div>

        <?php
        // bottom pager
        /** @var \Magento\Theme\Block\Html\Pager $pagerBottom */
        $pagerBottom = $block->getLayout()->createBlock(\Magento\Theme\Block\Html\Pager::class);
        if ($pagerBottom) {
            $pagerBottom->setAvailableLimit([12 => 12, 24 => 24, 48 => 48])
                ->setShowPerPage(false)
                ->setLimit($limit)
                ->setCollection($collection);
            echo $pagerBottom->toHtml();
        }
        ?>
    <?php endif; ?>
</div>
