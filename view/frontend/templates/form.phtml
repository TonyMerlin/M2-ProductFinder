<?php
/** @var $block \Merlin\ProductFinder\Block\Form */
$pre      = $block->getPreHtml();
$post     = $block->getPostHtml();
$action   = $block->getUrl('product-finder/index/results');

$sets     = $block->getAllowedAttributeSets();   // [id => name]
$profiles = $block->getAttributeSetProfiles();   // [setId => ['label','sections','map','extras']]

// JSON blobs for JS (safe embeds; no attribute escaping issues)
$profilesJson      = json_encode($profiles, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
$optionsBySetJson  = $block->getOptionsBySetFilteredByStockJson(); // shape: { "<setId>": { "<attr_code>": [ {value,label}, ... ] } }
?>
<div class="merlin-finder">
    <?php if ($pre): ?>
        <div class="merlin-finder__pre"><?= /* @noEscape */ $pre ?></div>
    <?php endif; ?>

    <!-- Provide data to JS via <script type="application/json"> -->
    <script type="application/json" id="mpf-profiles-json"><?= /* @noEscape */ $profilesJson ?></script>
    <script type="application/json" id="mpf-options-by-set"><?= /* @noEscape */ $optionsBySetJson ?></script>

    <form method="get"
          action="<?= $action ?>"
          id="merlin-finder-form"
          class="merlin-grid merlin-pf-form">

        <!-- Step 1: Attribute Set -->
        <div class="merlin-field merlin-pf-step" data-field="attribute_set_id" data-step="1">
            <label for="merlin-pf-attrset"><?= __('Product Group') ?></label>
            <select id="merlin-pf-attrset" name="attribute_set_id" class="admin__control-select">
                <option value=""><?= __('-- Select --') ?></option>
                <?php foreach ($sets as $id => $name): ?>
                    <option value="<?= (int)$id ?>"><?= $block->escapeHtml($name) ?></option>
                <?php endforeach; ?>
            </select>
        </div>

        <!-- Dynamic fields injected here by JS based on selected set/profile -->
        <div id="merlin-pf-dynamic-fields"></div>

        <div class="merlin-actions merlin-pf-step" data-field="submit" data-step="999" style="display:none">
            <button type="submit" class="action primary"><span><?= __('Find Products') ?></span></button>
            <a href="#" id="merlin-clear" class="action secondary"><?= __('Clear') ?></a>
        </div>
    </form>

    <?php if ($post): ?>
        <div class="merlin-finder__post"><?= /* @noEscape */ $post ?></div>
    <?php endif; ?>
</div>

<script type="text/x-magento-init">
{
  "#merlin-finder-form": {
    "Merlin_ProductFinder/js/form-progressive": {}
  }
}
</script>
