<?php
/** @var $block \Merlin\ProductFinder\Block\Form */
$pre      = $block->getPreHtml();
$post     = $block->getPostHtml();
$action   = $block->getUrl('product-finder/index/results');

$sets     = $block->getAllowedAttributeSets();      // [id => name]
$profiles = $block->getAttributeSetProfiles();      // [setId => {...}]

// Per-attribute-set in-stock options (preferred) // v1.5.0 Use Cached Data
$perSetOptions = method_exists($block, 'getInStockOptionsBySetCached')
    ? $block->getInStockOptionsBySetCached(array_keys($sets), $profiles)
    : [];

// Fallback: preload options by attribute code (used only if per-set is empty)
$codes = [];
foreach ($profiles as $sid => $prof) {
    if (!empty($prof['map']) && is_array($prof['map'])) {
        foreach ($prof['map'] as $code) { if ($code) $codes[$code] = true; }
    }
    if (!empty($prof['extras']) && is_array($prof['extras'])) {
        foreach ($prof['extras'] as $code) { if ($code) $codes[$code] = true; }
    }
}
$optionsByCode = $block->preloadOptionsByCodes(array_keys($codes));
?>
<div class="merlin-finder">
    <?php if ($pre): ?>
        <div class="merlin-finder__pre"><?= /* @noEscape */ $pre ?></div>
    <?php endif; ?>

    <!-- Single sources of truth for the JS (no duplicates) -->
    <script type="application/json" id="mpf-profiles-json">
        <?= /* @noEscape */ json_encode($profiles, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES) ?>
    </script>
    <script type="application/json" id="mpf-options-by-set">
        <?= /* @noEscape */ json_encode($perSetOptions, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES) ?>
    </script>
    <script type="application/json" id="mpf-options-json">
        <?= /* @noEscape */ json_encode($optionsByCode, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES) ?>
    </script>

    <form method="get"
          action="<?= $action ?>"
          id="merlin-finder-form"
          class="merlin-grid merlin-pf-form">

        <!-- Step 1: Attribute Set -->
        <div class="merlin-field merlin-pf-step" data-field="attribute_set_id" data-step="1">
            <label for="merlin-pf-attrset"><?= __('Product Type') ?></label>
            <select id="merlin-pf-attrset" name="attribute_set_id" class="admin__control-select">
                <option value=""><?= __('-- Select --') ?></option>
                <?php foreach ($sets as $id => $name): ?>
                    <option value="<?= (int)$id ?>"><?= $block->escapeHtml($name) ?></option>
                <?php endforeach; ?>
            </select>
        </div>

        <!-- Progressive fields injected here -->
        <div id="merlin-pf-dynamic-fields"></div>

        <div class="merlin-actions merlin-pf-step" data-field="submit" data-step="999" style="display:none">
            <button type="submit" class="action primary"><span><?= __('Find Products') ?></span></button>
            <a href="#" id="merlin-clear" class="action secondary"><?= __('Clear') ?></a>
        </div>
    </form>

    <?php if ($post): ?>
        <div class="merlin-finder__post"><?= /* @noEscape */ $post ?></div>
    <?php endif; ?>
</div>

<script type="text/x-magento-init">
{
  "#merlin-finder-form": {
    "Merlin_ProductFinder/js/form-progressive": {}
  }
}
</script>
