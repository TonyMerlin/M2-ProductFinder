<?php
/** @var $block \Merlin\ProductFinder\Block\Adminhtml\System\Config\Field\Profiles */
$attrSets = $block->getProductAttributeSets();   // [['id'=>..,'name'=>..], ...]
$fieldId  = $block->getHtmlId();

// Ensure alphabetical order by name (defensive, even if the collection was sorted)
usort($attrSets, function ($a, $b) {
    return strcasecmp($a['name'] ?? '', $b['name'] ?? '');
});
?>
<div class="merlin-pf-profiles"
     data-mpf-profiles
     data-field-id="<?= $block->escapeHtmlAttr($fieldId) ?>"
     data-attrsets='<?= $block->escapeHtmlAttr(json_encode($attrSets)) ?>'>

    <!-- Render Magento's real field (this is the actual value that gets saved).
         Keep it visible if you like seeing the JSON; otherwise set display:none. -->
    <div style="display:none">
        <?= /* real <textarea> with correct name/scope */ $block->getElement()->getElementHtml(); ?>
    </div>

    <div class="admin__field">
        <label class="admin__field-label">
            <span><?= __('Attribute Set Profiles') ?></span>
        </label>
        <div class="admin__field-control">
            <p><?= __('Select an attribute set, add sections/extras, then click “Save to JSON Field”, and finally “Save Config”.') ?></p>

            <div class="merlin-pf-profiles__top">
                <label><?= __('Attribute Set') ?></label>
                <select data-mpf-attrset>
                    <option value=""><?= __('-- choose --') ?></option>
                    <?php foreach ($attrSets as $set): ?>
                        <option value="<?= (int)$set['id'] ?>"><?= $block->escapeHtml($set['name']) ?></option>
                    <?php endforeach; ?>
                </select>
                <button type="button" class="action-default" data-mpf-new-profile>
                    <?= __('New / Reset Profile For This Set') ?>
                </button>
            </div>

            <div class="merlin-pf-profiles__body" data-mpf-sections></div>

            <div class="merlin-pf-profiles__actions">
                <button type="button" class="action-add" data-mpf-add-section>
                    <?= __('Add Section') ?>
                </button>
                <button type="button" class="action-add" data-mpf-add-extra>
                    <?= __('Add Extra Attribute') ?>
                </button>
                <button type="button" class="action-secondary" data-mpf-save-json>
                    <?= __('Save to JSON Field') ?>
                </button>
            </div>
        </div>
    </div>
</div>

<script type="text/x-magento-init">
{
    "[data-mpf-profiles]": { "Merlin_ProductFinder/js/profiles": {} }
}
</script>
