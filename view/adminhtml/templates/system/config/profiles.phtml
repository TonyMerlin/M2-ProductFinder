<?php
/** @var $block \Merlin\ProductFinder\Block\Adminhtml\System\Config\Field\Profiles */
$attrSets = $block->getProductAttributeSets();
$fieldId  = $block->getHtmlId();

// Ensure alphabetical order (defensive)
usort($attrSets, function ($a, $b) {
    return strcasecmp($a['name'] ?? '', $b['name'] ?? '');
});

// Attribute metadata for builder (visible-on-front attributes per set)
$attrMetaJson = $block->getAttributeMapJson();
?>
<!-- MPF profiles template -->
<div class="merlin-pf-profiles"
     data-mpf-profiles
     data-field-id="<?= $block->escapeHtmlAttr($fieldId) ?>"
     data-upload-url="<?= $block->escapeUrl($block->getImageUploadUrl()) ?>"
     data-attrsets='<?= $block->escapeHtmlAttr(json_encode($attrSets)) ?>'>

    <!-- Real JSON textarea Magento saves -->
    <div style="display:block">
        <?= /* real <textarea> with correct name/scope */ $block->getElement()->getElementHtml(); ?>
    </div>

    <div class="admin__field">
        <label class="admin__field-label">
            <span><?= __('Attribute Set Profiles') ?></span>
        </label>
        <div class="admin__field-control">
            <p>
                <?= __(
                    'Select an attribute set, drag attributes into the Profile Steps in the order you want customers to answer, ' .
                    'optionally upload an image, then click "Save Profile JSON" and finally "Save Config".'
                ) ?>
            </p>

            <div class="merlin-pf-profiles__top"
                 style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <label><?= __('Attribute Set') ?></label>
                <select data-mpf-attrset>
                    <option value=""><?= __('-- choose --') ?></option>
                    <?php foreach ($attrSets as $set): ?>
                        <option value="<?= (int)$set['id'] ?>"><?= $block->escapeHtml($set['name']) ?></option>
                    <?php endforeach; ?>
                </select>
                <button type="button" class="action-default" data-mpf-new-profile>
                    <?= __('New / Reset Profile For This Set') ?>
                </button>
                <button type="button" class="action-default" data-mpf-add-image>
                    <?= __('Add Image') ?>
                </button>
            </div>

            <!-- Image row (JS will fill & toggle this) -->
            <div class="merlin-pf-profiles__image" data-mpf-image-row
                 style="margin:12px 0; display:none;">
                <label class="admin__field-label" style="display:block;margin-bottom:6px;">
                    <span><?= __('Profile Image (optional)') ?></span>
                </label>

                <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
                    <div>
                        <img data-mpf-image-preview src="" alt=""
                             style="max-width:220px;display:none;border:1px solid #e3e6ef;border-radius:8px;"/>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                        <input type="file" data-mpf-image-input accept="image/*" />
                        <button type="button" class="action-secondary" data-mpf-image-upload>
                            <span><?= __('Upload') ?></span>
                        </button>
                        <button type="button" class="action-secondary" data-mpf-image-remove>
                            <span><?= __('Remove') ?></span>
                        </button>
                        <!-- keep URL between set switches -->
                        <input type="hidden" data-mpf-image-url value="" />
                    </div>
                </div>
                <small class="note">
                    <?= __('Shown between the first and second field on the frontend.') ?>
                </small>
            </div>

            <!-- Drag & Drop Builder -->
            <div class="merlin-pf-builder-wrapper">
                <div class="merlin-pf-builder-column">
                    <div class="merlin-pf-builder-title">
                        <?= __('Available Attributes') ?>
                    </div>
                    <ul class="merlin-pf-attr-list" data-mpf-attr-list></ul>
                    <small class="note">
                        <?= __('Drag from here into "Profile Steps" to include attributes in the wizard.') ?>
                    </small>
                </div>

                <div class="merlin-pf-builder-column">
                    <div class="merlin-pf-builder-title">
                        <?= __('Profile Steps (drag to order)') ?>
                    </div>
                    <ul class="merlin-pf-step-list" data-mpf-step-list></ul>
                    <small class="note">
                        <?= __('This defines the question order the customer sees on the frontend.') ?>
                    </small>
                </div>
            </div>

            <!-- Legacy container kept ONLY for backward compat (hidden, no buttons) -->
            <div class="merlin-pf-legacy-wrapper" style="display:none;">
                <div class="merlin-pf-profiles__body" data-mpf-sections></div>
            </div>

            <!-- Visible save button (builder + extras from JSON all go through this) -->
            <div style="margin-top:12px;">
                <button type="button" class="action-secondary" data-mpf-save-json>
                    <?= __('Save Profile JSON') ?>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Attribute metadata JSON for JS builder -->
<script type="application/json" id="mpf-attr-meta-json">
<?= /* @noEscape */ $attrMetaJson ?>
</script>

<script type="text/x-magento-init">
{
    "[data-mpf-profiles]": { "Merlin_ProductFinder/js/profiles": {} }
}
</script>
